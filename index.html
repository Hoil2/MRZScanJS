<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extract MRZ with Tesseract and OpenCV</title>

    <link rel="stylesheet" href="css/bootstrap/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <script src="js/jquery-3.7.0.min.js"></script>
    <!-- v4 -->
    <script src='js/tesseract.min.js'></script>
    <script src="js/mrz-helper.js"></script>

    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>

    <style>
        .loader {
            border: 16px solid #f3f3f3;
            border-radius: 50%;
            border-top: 16px solid #3498db;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            display: none;
            margin-top: -4.05em;
            margin-left: -4.05em;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
            display: none;
        }

        @keyframes spin {
            0% {
                transform: rotate(360deg);
            }
            100% {
                transform: rotate(0deg);
            }
        }

        #extracted-text {
            font-family: monospace;
            overflow: hidden;
            resize: none;
            width: 22rem;
            font-size: 0.9rem;
        }

        @media (max-width: 600px) {
            #extracted-text {
                width: 18.5rem;
                font-size: 0.6rem;
            }
        }
    </style>
</head>
<body>
    <div id="overlay" class="overlay"></div>
    <div id="loader" class="loader"></div>
    <main class="container d-flex flex-column align-items-center py-4">
        <div class="w-100 d-flex justify-content-center">
            <div class="text-center">
                <div id="image" class="p-2 border border-dark rounded" style="width: 250px; cursor: pointer;">
                    <p class="h4"><i class="bi bi-camera-fill me-2"></i>Scan passport</p>
                </div>
                <div id="qrcode" class="mt-4 mb-4 d-flex justify-content-center" style="height: 256px"></div>
            </div>
        </div>
        <h4 class="mt-3">MRZ</h4>
        <div class="form-group">
            <textarea id="extracted-text" class="form-control"></textarea>
        </div>
        <input id="file" type="file" class="d-none" onchange="handleChange(event)" />
    </main>
    
    <div style="visibility: hidden; position: fixed;">
        <h3>Actual image uploaded</h3>
        <div style="width: 100%; border: 1px solid black; text-align: center;">
            <img id="passport-img" height="auto" />
            <canvas id="adjusted-img" style="width:fit-content;" ></canvas>
        </div>
    </div>

    <script>
        function loadingStart() {
            document.getElementById('loader').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';    
        }

        function loadingEnd() {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';        
        }

        function generateQrCode(str) {
            document.getElementById("qrcode").innerHTML = "";
            var qrcode = new QRCode(document.getElementById("qrcode"), {
                text: str,
                width: 256,
                height: 256
            });
        }

        let imgElement = document.getElementById("passport-img");
        let adjustElement = document.getElementById("adjusted-img");
        let textElement = document.getElementById("extracted-text");
        let file;

        $("div[id='image']").click(function() {
            $("input[id='file']").click();
        });

        const handleChange = (e) => {
            file = e.target.files[0];
            imgElement.src = URL.createObjectURL(e.target.files[0]);
            textElement.value = "";
        };

        let endTime;
        let executionTime;

        imgElement.onload = function() {
            try {
                loadingStart();
                let startTime = performance.now();
                let src = cv.imread('passport-img');
                let dst = new cv.Mat();

                let dsize = getSize(imgElement.naturalWidth, imgElement.naturalHeight, 1280, 1280);
                cv.resize(src, dst, dsize);

                let rgb_planes = new cv.MatVector();
                cv.split(dst, rgb_planes);

                let result_norm_planes = [];

                for (let i = 0; i < 3; i++) {
                    let plane = rgb_planes.get(i);
                    let dilated_img = new cv.Mat();
                    let dilated_kernel = cv.Mat.ones(7, 7, cv.CV_8U);
                    cv.dilate(plane, dilated_img, dilated_kernel);

                    let bg_img = new cv.Mat();
                    cv.medianBlur(dilated_img, bg_img, 21);

                    let diff_img = new cv.Mat();
                    cv.absdiff(plane, bg_img, diff_img);

                    let scalar = new cv.Mat(plane.rows, plane.cols, plane.type(), new cv.Scalar(255,255,255));
                    cv.subtract(scalar, diff_img, diff_img);

                    let norm_img = new cv.Mat();
                    cv.normalize(diff_img, norm_img, 0, 255, cv.NORM_MINMAX, cv.CV_8UC1);

                    result_norm_planes.push(norm_img);

                    plane.delete();
                    dilated_img.delete();
                    dilated_kernel.delete();
                    bg_img.delete();
                    scalar.delete();
                    diff_img.delete();
                }

                let result_norm = new cv.Mat();

                let result_norm_vector = new cv.MatVector();
                for (let i = 0; i < result_norm_planes.length; i++) {
                    result_norm_vector.push_back(result_norm_planes[i]);
                }

                cv.merge(result_norm_vector, result_norm);

                cv.imshow('adjusted-img', result_norm);

                endTime = performance.now();
                executionTime = endTime - startTime;
                console.log(`Image pre-processing time: ${executionTime} milliseconds`);

                startTime = performance.now();
                Tesseract.recognize(adjustElement.toDataURL(), 'mrz', { langPath: 'model' })
                        .then(({ data: { text } }) => {
                            try {
                                console.log(text);
                                let mrz = getMRZCode(text);
                                textElement.value = mrz.join("\r\n");
                                autoResizeTextarea(textElement);
                                generateQrCode(textElement.value);
                                endTime = performance.now();
                                executionTime = endTime - startTime;
                                console.log(`Tesseract ocr time: ${executionTime} milliseconds`);
                            } catch(err) {
                                alert(text);
                            } finally {
                                loadingEnd();
                            }
                        });

                src.delete();
                dst.delete();
                rgb_planes.delete();
                result_norm.delete();
                result_norm_vector.delete();
                for(let i = 0; i < result_norm_planes.length; i++) {
                    result_norm_planes[i].delete();
                }
            } catch(err) {
                loadingEnd();
            }
        };

        // textarea 높이 자동 조절 함수
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = `${textarea.scrollHeight}px`;
        }

        
        // 이미지의 크기를 조정하는 함수
        function getSize(nowWidth, nowHeight, maxWidth, maxHeight) {
            // 각 비율을 계산해서 이미지가 최대 크기를 넘지 않도록 제한
            let ratio = 1;
            let widthRatio = nowWidth > maxWidth ? maxWidth / nowWidth : 1;
            let heightRatio = nowHeight > maxHeight ? maxHeight / nowHeight : 1;

            ratio = Math.min(widthRatio, heightRatio);

            let width = nowWidth * ratio;
            let height = nowHeight * ratio;

            return new cv.Size(width, height);
        }

        // function onOpenCvReady() {
        //     document.getElementById('status').innerHTML = 'OpenCV.js is ready.';
        // }
    </script>

    <script async src="js/opencv-4.8.0.min.js"></script>

    
</body>
</html>
